/*
* tgame 
* 
* The MIT License (MIT)
* 
* Copyright (c) 2014 Tarek Sherif
* 
* Permission is hereby granted, free of charge, to any person obtaining a copy of
* this software and associated documentation files (the "Software"), to deal in
* the Software without restriction, including without limitation the rights to
* use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
* the Software, and to permit persons to whom the Software is furnished to do so,
* subject to the following conditions:
* 
* The above copyright notice and this permission notice shall be included in all
* copies or substantial portions of the Software.
* 
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
* FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
* COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
* IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
* CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
*/

(function(){"use strict";function d(e,t,n){r.push({name:e,type:t,url:n})}function v(){r.forEach(function(e){h[e.type+"s"][e.name]=p[e.type](e.url,function(){i++;if(i===r.length){m()}})})}function m(){requestAnimationFrame(g);setTimeout(m,s);c=Date.now();if(h.STATES.hasOwnProperty(h.state)){h.STATES[h.state](c-l)}l=c;f.forEach(function(e){h.entities[e]=h.entities[e].filter(function(e){return!e.remove})})}function g(){t.save();t.fillStyle=h.clear_color||"#000000";t.fillRect(0,0,e.width,e.height);t.translate(-h.camera.x,-h.camera.y);f.forEach(function(e){h.entities[e].forEach(function(e){if(!e.hidden){if(e.fixed){t.save();t.translate(h.camera.x,h.camera.y);e.draw(t);t.restore()}else{e.draw(t)}}})});t.restore()}var e,t;var n={x:0,y:0};var r=[];var i=0;var s=1e3/60;var o="";var u={};var a={};var f;var l,c;(function(){var t=new Audio;var n=t.canPlayType("audio/mpeg");if(n==="probably"||n==="maybe"){o=".mp3";return}n=t.canPlayType("audio/ogg codecs='vorbis'");if(t.canPlayType("audio/ogg codecs='vorbis'")){o=".ogg";return}})();var h=window.tgame={images:{},sounds:{},entities:{},state:null,setFPS:function(e){s=1e3/e},setCanvas:function(r){e=r;t=e.getContext("2d");var i=e.offsetLeft;var s=e.offsetTop;var o=e.offsetParent;while(o.offsetParent){i+=o.offsetLeft;s+=o.offsetTop;o=o.offSetParent}n.x=i;n.y-s},getCanvas:function(){return e},getContext:function(){return t},addImage:function(e,t){d(e,"image",t)},addSound:function(e,t){d(e,"sound",t)},addKeyControl:function(e,t,n){u[e]=t;a[e]=n},removeKeyControl:function(e){u[e]=null;a[e]=null},mouseDown:function(t){e.addEventListener("mousedown",function(e){t(e.clientX-n.x,e.clientY-n.y)},false)},mouseMove:function(t){e.addEventListener("mousemove",function(e){t(e.clientX-n.x,e.clientY-n.y)},false)},mouseUp:function(e){document.addEventListener("mouseup",function(t){e(t.clientX-n.x,t.clientY-n.y)},false)},setRenderOrder:function(e){f=e},clearEntities:function(){var e=arguments.length>0?Array.prototype.slice.call(arguments):Object.keys(h.entities);e.forEach(function(e){h.entities[e].length=0})},start:function(){f=f||Object.keys(h.entities);h.camera.width=h.camera.width||e.width;h.camera.height=h.camera.height||e.height;if(Object.keys(u).length>0){document.addEventListener("keydown",function(e){if(u[e.keyCode]){if(u[e.keyCode](e)!==false){e.preventDefault()}}},false);document.addEventListener("keyup",function(e){if(a[e.keyCode]){if(a[e.keyCode](e)!==false){e.preventDefault()}}},false)}if(r.length>0){v()}else{l=Date.now();m()}}};h.camera={x:0,y:0,width:0,height:0,innerLeft:function(){return this.x+this.width*.25},innerRight:function(){return this.x+this.width*.75},innerTop:function(){return this.y+this.height*.25},innerBottom:function(){return this.y+this.height*.75}};h.collision={rectangle:function(e,t){var n=null;var r=null;var i=e.width*.5;var s=e.height*.5;var o=e.x+i;var u=e.y+s;var a=t.width*.5;var f=t.height*.5;var l=t.x+a;var c=t.y+f;var h=l-o;var p=c-u;var d=Math.abs(h);var v=Math.abs(p);var m=i+a;var g=s+f;var y,b;if(d<m&&v<g){y=m-d;b=g-v;if(b<y){r=p>0?"bottom":"top"}else{r=h>0?"right":"left"}n={dx:h,dy:p,side:r,overlap_x:y,overlap_y:b}}return n},circle:function(e,t){var n=e.width*.5;var r=e.height*.5;var i=e.x+n;var s=e.y+r;var o=t.width*.5;var u=t.height*.5;var a=t.x+o;var f=t.y+u;var l=a-i;var c=f-s;return Math.sqrt(l*l+c*c)<n+o},blockCircle:function(e,t){var n=e.width*.5;var r=e.height*.5;var i=e.x+n;var s=e.y+r;var o=t.width*.5;var u=t.height*.5;var a=t.x+o;var f=t.y+u;var l=a-i;var c=f-s;var h=Math.sqrt(l*l+c*c);var p=n+o;var d;if(h<p){d=p-h;e.x-=d*l/h;e.y-=d*c/h}},blockRectangle:function(e,t){var n=h.collision.rectangle(e,t);if(n){(({top:function(){e.y+=n.overlap_y},bottom:function(){e.y-=n.overlap_y},left:function(){e.x+=n.overlap_x},right:function(){e.x-=n.overlap_x}}))[n.side]()}return n}};h.effects={fade:function(e){function f(e){if(e.alpha<.99){e.alpha=e.alpha*n||.01}else{e.alpha=1;if(s){e.remove=true}}}function l(e){if(e.alpha>.01){e.alpha*=n}else{e.alpha=0;if(s){e.remove=true}}}function c(e){return e.alpha<1}function h(e){return e.alpha>0}e=e||{};var t=e.objects||[];var n=typeof e.ratio==="number"?e.ratio:.9;var r=typeof e.interval==="number"?e.interval:30;var i=typeof e.delay==="number"?e.delay:0;var s=e.remove||false;var o=e.complete;var u,a;if(n>1){u=f;a=c}else{u=l;a=h}setTimeout(function p(){t.forEach(u);t=t.filter(a);if(t.length>0){setTimeout(p,r)}else if(typeof o==="function"){o()}},i)}};var p={image:function(e,t){var n=new Image;n.addEventListener("load",t);n.src=e;return n},sound:function(e,t){var n=new Audio(e+o);n.addEventListener("canplaythrough",t);n.load();return n}};h.keyboard={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSEBREAK:19,CAPS_LOCK:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMAL_POINT:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,SEMI_COLON:186,EQUAL:187,COMMA:188,DASH:189,PERIOD:190,FORWARD_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRAKET:221,SINGLE_QUOTE:222}})()
